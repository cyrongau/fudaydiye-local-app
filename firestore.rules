rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: User checks
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // 1. Users Collection
    match /users/{userId} {
      allow read: if (isSignedIn() && isOwner(userId)) 
                  || resource.data.role == 'VENDOR' 
                  || resource.data.role == 'RIDER' 
                  || resource.data.parentVendorId == request.auth.uid
                  || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN'
                  || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'FUDAYDIYE_ADMIN';
      allow write: if isSignedIn() && (
        isOwner(userId) 
        || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN' 
        || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'FUDAYDIYE_ADMIN'
        || (request.resource.data.parentVendorId == request.auth.uid)
      );

      // Subcollection: Following (User manages their own list)
      match /following/{targetId} {
        allow read: if isSignedIn() && isOwner(userId);
        allow write: if isSignedIn() && isOwner(userId);
      }

      // Subcollection: Followers (User adds themselves to others' lists)
      match /followers/{followerId} {
        allow read: if isSignedIn() && (isOwner(userId) || request.auth.uid == followerId);
        allow write: if isSignedIn() && request.auth.uid == followerId;
      }
    }

    // 2. Products Collection
    match /products/{productId} {
      allow read: if true;
      allow create: if isSignedIn() && (request.resource.data.vendorId == request.auth.uid || request.auth.token.role == 'FUDAYDIYE_ADMIN');
      allow update: if isSignedIn() && (
        (resource.data.vendorId == request.auth.uid && request.resource.data.vendorId == request.auth.uid) ||
        request.auth.token.role == 'FUDAYDIYE_ADMIN'
      );
      allow delete: if isSignedIn() && (resource.data.vendorId == request.auth.uid || request.auth.token.role == 'FUDAYDIYE_ADMIN');
    }

    // 2.a Categories (Public Read)
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // 3. Orders Collection (LOCKED - Backend Only)
    // Exception: Customers/Vendors/Riders can READ their relevant orders
    match /orders/{orderId} {
      allow create: if false; // Secure Backend creation only
      allow update: if false; // Secure Backend update only
      
      allow read: if isSignedIn() && (
        resource.data.customerId == request.auth.uid || 
        resource.data.vendorId == request.auth.uid ||
        resource.data.riderId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'FUDAYDIYE_ADMIN' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'CLIENT'
      );
    }

    // 7. CMS Content (LOCKED - Backend Only)
    match /cms_content/{docId} {
      allow read: if true;
      allow write: if false; // Admin API only
    }

    // 8. Carts
    match /carts/{cartId} {
      allow read, write: if true; // Allow guests
    }

    // 9. Wishlists 
    match /wishlists/{wishlistId} {
      allow read, write: if true; // Allow guests
    }

    // 4. System Config & Settings (LOCKED - Backend Only / Admin Read)
    match /system_config/{configId} {
      allow read: if isSignedIn() && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'FUDAYDIYE_ADMIN'
      );
      allow write: if false; // Admin API only
    }

    // 10. Wallets
    match /wallets/{walletId} {
      allow read: if isSignedIn() && (walletId == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN');
      allow write: if false; // Functions only
    }

    // 11. Financials (Transactions & Payouts)
    match /transactions/{txId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'FUDAYDIYE_ADMIN' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN'
      );
      allow write: if false; // System only
    }

    match /payouts/{payoutId} {
      allow read: if isSignedIn() && (
        resource.data.vendorId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'FUDAYDIYE_ADMIN' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN'
      );
      allow create: if isSignedIn() && request.resource.data.vendorId == request.auth.uid;
    }

    // 12. Reviews
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn(); // Customers can review
      allow update: if isSignedIn() && (
        resource.data.vendorId == request.auth.uid || // Vendor can reply
        resource.data.userId == request.auth.uid // Author can edit
      );
    }

    // 13. Notifications
    match /notifications/{notificationId} {
      allow read, write: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn(); // System/Functions + maybe direct client triggers? 
    }

    // 14. Live Sessions
    match /live_sessions/{sessionId} {
      allow read: if true;
      
      // CREATE: LOCKED - Backend Only (API /live)
      allow create: if false;

      // UPDATE: LOCKED - Backend Only (API /live patch)
      // Exception: Viewer Count (Anonymous) - Keep for now if handled by client side aggregation, 
      // but ideally backend handles join/leave. 
      // Code review showed viewerCount increment happening in `cleanupResources` via deleteDoc viewer?
      // Wait, `viewerCount` increment/decrement is usually done via valid client side logic in some architectures, 
      // OR cloud function triggers on subcollection write.
      // Current `LiveStream.tsx` uses: `updateDoc(doc(db, "live_sessions", id), { viewerCount: increment(-1) });`
      // So we MUST allow viewerCount update for now, or migrate that too.
      // Plan was "Block client side writes".
      // Let's migrate viewer count to backend? Or just allow it specifically.
      // Allowing specific field update is safer than generic update.
      allow update: if (
         // Allow anonymous viewer count updates
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewerCount'])
      );
      
      // DELETE: Owner Only
      allow delete: if isSignedIn() && (
        resource.data.hostId == request.auth.uid || 
        resource.data.vendorId == request.auth.uid || 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'FUDAYDIYE_ADMIN'
      );
      
      // Subcollection: Viewer Tracking
      match /viewers/{viewerId} {
        allow read, write: if true; // Public access needed for guests
      }
      
      // Subcollection: Chat
      match /chat/{messageId} {
        allow read: if true;
        allow create: if isSignedIn();
      }

      // Subcollection: Reactions (Hearts)
      match /reactions/{reactionId} {
        allow read: if true;
        allow create: if true; // Allow guests to heart
      }
    }

    // 15. Shipping Zones
    match /shipping_zones/{zoneId} {
      allow read: if true;
      allow write: if isSignedIn() && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'FUDAYDIYE_ADMIN' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPER_ADMIN'
      );
    }

    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
